services:
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - portfolio
      - pks
      - podology
    networks:
      - portfolio_net

  portfolio:
    build: .
    container_name: portfolio
    expose:
      - "5000"
    environment:
      - FLASK_DEBUG=development
    networks:
      - portfolio_net

  pks:
    image: pks-dashboard
    container_name: pks
    expose:
      - "8080"
    environment:
      - DASH_URL_PREFIX=/pks/
    networks:
      - portfolio_net

  podology-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.2
    environment:
      - discovery.type=single-node
      - ELASTIC_PASSWORD=06h1yvYGw6mtZ9Ex3K+FfBuksHGdp1UC
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
    expose:
      - "9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
      - ./certs:/usr/share/elasticsearch/config/certs
    mem_limit: 2g
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio_net

  podology-redis:
    image: redis:7
    expose:
      - "6379"
    networks:
      - portfolio_net

  podology:
    image: podology-app:latest
    container_name: podology
    depends_on:
      podology-elasticsearch:
        condition: service_healthy
      podology-redis:
        condition: service_started
    environment:
      - ELASTICSEARCH_HOST=podology-elasticsearch
      - ELASTICSEARCH_PORT=9200
      - REDIS_HOST=podology-redis
      - REDIS_PORT=6379
      - PORT=8080
      - EMBEDDER_MODEL=multi-qa-mpnet-base-dot-v1
      - EMBEDDER_DIMS=768
      - DASH_URL_PREFIX=/podology/
    expose:
      - "8080"
    volumes:
      - ../podology/data:/app/data
    restart: unless-stopped
    networks:
      - portfolio_net

networks:
  portfolio_net:
    driver: bridge

volumes:
  elasticsearch-data:
